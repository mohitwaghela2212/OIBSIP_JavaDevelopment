<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Library Management System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind to use 'Inter' font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#1D4ED8', // Blue-700
                        'secondary': '#FBBF24', // Amber-400
                        'accent': '#DC2626', // Red-600
                        'bg-main': '#F9FAFB', // Gray-50
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for better aesthetics */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #E5E7EB; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-track { background: #F9FAFB; }
        .custom-scroll { scrollbar-width: thin; scrollbar-color: #E5E7EB #F9FAFB; }
    </style>
</head>
<body class="bg-bg-main min-h-screen font-sans antialiased p-4">

    <div id="app" class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden md:flex">
        
        <!-- Sidebar Navigation -->
        <aside class="w-full md:w-64 bg-primary p-6 text-white flex-shrink-0">
            <h1 class="text-3xl font-extrabold mb-8 border-b border-blue-400/50 pb-2">Digital Library</h1>
            
            <div class="space-y-4 mb-8">
                <button onclick="changeMode('user')" class="w-full text-left p-3 rounded-lg transition duration-200 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-secondary" id="mode-user-btn">
                    <span class="font-semibold text-lg">User Module</span>
                    <p class="text-sm text-blue-200">View, Search, Issue & Return</p>
                </button>
                <button onclick="changeMode('admin')" class="w-full text-left p-3 rounded-lg transition duration-200 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-secondary" id="mode-admin-btn">
                    <span class="font-semibold text-lg">Admin Module</span>
                    <p class="text-sm text-blue-200">Manage Books & Members</p>
                </button>
            </div>
            
            <!-- User Info (Simulated Login) -->
            <div class="pt-4 mt-auto border-t border-blue-400/50">
                <p class="text-sm text-blue-200">Current User:</p>
                <p class="text-lg font-bold" id="user-display-id">User 101</p>
                <span class="text-xs font-mono bg-blue-800 px-2 py-0.5 rounded-full" id="user-role-tag">User</span>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-grow p-6 md:p-8 custom-scroll max-h-[80vh] overflow-y-auto">
            <header class="mb-6 pb-4 border-b">
                <h2 class="text-4xl font-bold text-gray-800" id="module-title">User Module</h2>
                <p class="text-gray-500" id="module-description">Browse and manage your book transactions.</p>
            </header>

            <!-- User Module Content -->
            <div id="user-content" class="space-y-8">
                <!-- Search and Browse -->
                <div class="bg-gray-50 p-6 rounded-xl shadow-inner">
                    <h3 class="text-2xl font-semibold mb-4 text-primary">Search & Browse Books</h3>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="text" id="search-input" placeholder="Search by Title, Author, or ISBN..." 
                               class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary">
                        <button onclick="renderBooks()" 
                                class="bg-secondary text-primary font-bold py-3 px-6 rounded-lg hover:bg-amber-500 transition duration-150">
                            Search
                        </button>
                    </div>
                    <div id="book-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
                        <!-- Book cards will be injected here -->
                    </div>
                </div>

                <!-- Issue/Return/Fines -->
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Issue Book -->
                    <div class="bg-white p-6 rounded-xl shadow border border-blue-100">
                        <h3 class="text-2xl font-semibold mb-4 text-green-600">Issue Book</h3>
                        <p class="text-sm text-gray-500 mb-4">Enter a book ID to issue it to the current user (Max 3 books).</p>
                        <input type="text" id="issue-book-id" placeholder="Book ID (e.g., B001)" 
                               class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-green-500 focus:border-green-500">
                        <button onclick="issueBook()" 
                                class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-150">
                            Confirm Issue
                        </button>
                    </div>

                    <!-- Return Book & Fine Calculation -->
                    <div class="bg-white p-6 rounded-xl shadow border border-red-100">
                        <h3 class="text-2xl font-semibold mb-4 text-accent">Return Book & Fines</h3>
                        <p class="text-sm text-gray-500 mb-4">Enter the book ID you are returning.</p>
                        <input type="text" id="return-book-id" placeholder="Book ID (e.g., B001)" 
                               class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-accent focus:border-accent">
                        <button onclick="returnBook()" 
                                class="w-full bg-accent text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition duration-150">
                            Confirm Return
                        </button>
                        <div id="fine-output" class="mt-4 p-3 bg-red-50 text-accent font-semibold rounded-lg hidden"></div>
                    </div>
                </div>

                <!-- User Transactions -->
                <div class="bg-white p-6 rounded-xl shadow">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-800">My Issued Books</h3>
                    <div id="user-issued-list" class="space-y-3">
                        <!-- Issued books will be listed here -->
                        <p class="text-gray-500">No books currently issued.</p>
                    </div>
                </div>

                <!-- Query/Email Option -->
                <div class="bg-primary/10 p-6 rounded-xl shadow border border-primary">
                    <h3 class="text-2xl font-semibold mb-4 text-primary">Librarian Query / Email Option</h3>
                    <p class="text-sm text-gray-600 mb-4">Ask a question about a book, a library policy, or report an issue. (Simulated)</p>
                    <textarea id="query-textarea" rows="3" placeholder="Enter your query here..." 
                              class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-primary focus:border-primary"></textarea>
                    <button onclick="submitQuery()" 
                            class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-800 transition duration-150">
                        Submit Query (Simulated API Call)
                    </button>
                    <div id="query-response" class="mt-4 p-3 bg-blue-100 text-blue-800 rounded-lg hidden"></div>
                </div>
            </div>

            <!-- Admin Module Content -->
            <div id="admin-content" class="space-y-8 hidden">
                <!-- Manage Books -->
                <div class="bg-white p-6 rounded-xl shadow">
                    <h3 class="text-2xl font-semibold mb-4 text-primary">Manage Books (Add/Edit/Delete)</h3>
                    <form id="book-form" class="space-y-4">
                        <input type="text" id="admin-book-id" placeholder="Book ID (e.g., B001)" required 
                               class="w-full p-3 border rounded-lg focus:ring-primary focus:border-primary">
                        <input type="text" id="admin-title" placeholder="Title" required 
                               class="w-full p-3 border rounded-lg focus:ring-primary focus:border-primary">
                        <input type="text" id="admin-author" placeholder="Author" required 
                               class="w-full p-3 border rounded-lg focus:ring-primary focus:border-primary">
                        <input type="number" id="admin-copies" placeholder="Available Copies" required 
                               class="w-full p-3 border rounded-lg focus:ring-primary focus:border-primary">
                        <div class="flex gap-4">
                            <button type="button" onclick="addUpdateBook(true)" class="flex-1 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition duration-150">
                                Add New Book
                            </button>
                            <button type="button" onclick="addUpdateBook(false)" class="flex-1 bg-yellow-600 text-white font-bold py-3 rounded-lg hover:bg-yellow-700 transition duration-150">
                                Update Book
                            </button>
                            <button type="button" onclick="deleteBook()" class="flex-1 bg-accent text-white font-bold py-3 rounded-lg hover:bg-red-700 transition duration-150">
                                Delete Book
                            </button>
                        </div>
                    </form>

                    <h4 class="text-xl font-semibold mt-8 mb-4">Current Book List</h4>
                    <div id="admin-book-list" class="space-y-2">
                        <!-- Admin book list table will be injected here -->
                    </div>
                </div>

                <!-- Manage Members -->
                <div class="bg-white p-6 rounded-xl shadow">
                    <h3 class="text-2xl font-semibold mb-4 text-primary">Manage Members</h3>
                    <form id="member-form" class="space-y-4">
                        <input type="text" id="admin-member-id" placeholder="Member ID (e.g., U101)" required 
                               class="w-full p-3 border rounded-lg focus:ring-primary focus:border-primary">
                        <input type="text" id="admin-member-name" placeholder="Member Name" required 
                               class="w-full p-3 border rounded-lg focus:ring-primary focus:border-primary">
                        <div class="flex gap-4">
                            <button type="button" onclick="addUpdateMember(true)" class="flex-1 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition duration-150">
                                Add New Member
                            </button>
                            <button type="button" onclick="deleteMember()" class="flex-1 bg-accent text-white font-bold py-3 rounded-lg hover:bg-red-700 transition duration-150">
                                Delete Member
                            </button>
                        </div>
                    </form>

                    <h4 class="text-xl font-semibold mt-8 mb-4">Current Member List</h4>
                    <div id="admin-member-list" class="space-y-2">
                        <!-- Admin member list table will be injected here -->
                    </div>
                </div>

                <!-- Reporting (Simulated) -->
                <div class="bg-gray-50 p-6 rounded-xl shadow-inner">
                    <h3 class="text-2xl font-semibold mb-4 text-primary">Report Generation (Simulated)</h3>
                    <p class="text-gray-600">This section would generate reports on overdue books, popular books, and active members.</p>
                    <button onclick="generateReport()" class="mt-4 bg-primary text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-800 transition duration-150">
                        Generate All Reports
                    </button>
                    <div id="report-output" class="mt-4 p-3 bg-blue-100 text-blue-800 rounded-lg hidden"></div>
                </div>

            </div>

            <!-- Global Message Box -->
            <div id="message-box" class="fixed bottom-4 right-4 p-4 rounded-lg text-white font-semibold shadow-lg transition-opacity duration-300 opacity-0 hidden z-50"></div>
        </main>
    </div>

    <script>
        // --- Simulated Database & State ---
        let books = [
            { id: 'B001', title: 'The Great Gatsby', author: 'F. Scott Fitzgerald', copies: 5, category: 'Fiction', issuedTo: null, issueDate: null },
            { id: 'B002', title: 'Sapiens', author: 'Yuval Noah Harari', copies: 3, category: 'Non-Fiction', issuedTo: null, issueDate: null },
            { id: 'B003', title: 'To Kill a Mockingbird', author: 'Harper Lee', copies: 8, category: 'Fiction', issuedTo: null, issueDate: null },
            { id: 'B004', title: 'Introduction to Algorithms', author: 'Thomas H. Cormen', copies: 2, category: 'Science', issuedTo: null, issueDate: null },
            { id: 'B005', title: 'The Lord of the Rings', author: 'J.R.R. Tolkien', copies: 1, category: 'Fantasy', issuedTo: null, issueDate: null },
        ];

        let members = [
            { id: 'U101', name: 'User 101', issuedBooks: [] },
            { id: 'U102', name: 'Jane Doe', issuedBooks: [] },
        ];

        const currentUser = 'U101'; // Default User ID
        const MAX_ISSUED_BOOKS = 3;
        const FINE_RATE_PER_DAY = 0.50; // Currency unit per day

        // --- Utility Functions ---

        /**
         * Displays a temporary, self-dismissing message box.
         * @param {string} message - The message content.
         * @param {string} type - 'success', 'error', or 'info'.
         */
        function showMessage(message, type = 'info') {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.classList.remove('bg-green-600', 'bg-accent', 'bg-blue-500', 'hidden');

            switch (type) {
                case 'success': box.classList.add('bg-green-600'); break;
                case 'error': box.classList.add('bg-accent'); break;
                case 'info': default: box.classList.add('bg-blue-500'); break;
            }

            box.classList.remove('opacity-0');
            box.classList.add('opacity-100');
            box.style.display = 'block';

            setTimeout(() => {
                box.classList.remove('opacity-100');
                box.classList.add('opacity-0');
                setTimeout(() => { box.style.display = 'none'; }, 300);
            }, 3000);
        }

        // --- Core Module Logic (Admin/User) ---

        let currentMode = 'user';

        /**
         * Toggles between User and Admin modules.
         * @param {string} mode - 'user' or 'admin'
         */
        function changeMode(mode) {
            currentMode = mode;
            const isUser = mode === 'user';
            
            // UI visibility
            document.getElementById('user-content').classList.toggle('hidden', !isUser);
            document.getElementById('admin-content').classList.toggle('hidden', isUser);

            // Button styling
            document.querySelectorAll('aside button').forEach(btn => {
                btn.classList.remove('bg-blue-600');
            });
            document.getElementById(`mode-${mode}-btn`).classList.add('bg-blue-600');
            
            // Header update
            document.getElementById('module-title').textContent = isUser ? 'User Module' : 'Admin Module';
            document.getElementById('module-description').textContent = isUser 
                ? 'Browse and manage your book transactions.' 
                : 'Full control over books, members, and reports.';

            // User Info Tag
            document.getElementById('user-role-tag').textContent = isUser ? 'User' : 'Admin';
            
            // Re-render relevant data
            if (isUser) {
                renderBooks();
                renderUserIssuedBooks();
            } else {
                renderAdminBooks();
                renderAdminMembers();
            }
        }

        // --- User Module Functions ---

        /**
         * Renders the list of books based on the search input.
         */
        function renderBooks() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const bookListContainer = document.getElementById('book-list');
            bookListContainer.innerHTML = '';

            const filteredBooks = books.filter(book => 
                book.title.toLowerCase().includes(query) ||
                book.author.toLowerCase().includes(query) ||
                book.id.toLowerCase().includes(query) ||
                book.category.toLowerCase().includes(query)
            );

            if (filteredBooks.length === 0) {
                bookListContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">No books found matching your search.</p>';
                return;
            }

            filteredBooks.forEach(book => {
                const isAvailable = book.copies > 0;
                const availabilityClass = isAvailable ? 'text-green-600' : 'text-accent';
                const availabilityText = isAvailable ? `Available: ${book.copies}` : 'Out of Stock';

                const card = `
                    <div class="bg-white p-5 rounded-lg shadow-md border-l-4 ${isAvailable ? 'border-primary' : 'border-accent'}">
                        <p class="text-sm text-gray-400 font-mono mb-1">${book.id} | ${book.category}</p>
                        <h4 class="text-xl font-bold text-gray-800">${book.title}</h4>
                        <p class="text-gray-600 mb-3">By ${book.author}</p>
                        <p class="font-semibold ${availabilityClass}">${availabilityText}</p>
                        ${isAvailable ? `<button onclick="document.getElementById('issue-book-id').value='${book.id}'; showMessage('Book ID copied to Issue field.', 'info')" 
                            class="mt-2 text-primary hover:text-blue-700 text-sm font-medium">Quick Issue</button>` : ''}
                    </div>
                `;
                bookListContainer.innerHTML += card;
            });
            renderUserIssuedBooks(); // Keep issued list updated
        }

        /**
         * Issues a book to the current user.
         */
        function issueBook() {
            const bookId = document.getElementById('issue-book-id').value.trim().toUpperCase();
            if (!bookId) {
                showMessage("Please enter a Book ID.", 'error');
                return;
            }

            const book = books.find(b => b.id === bookId);
            const user = members.find(m => m.id === currentUser);

            if (!book) {
                showMessage(`Book ID ${bookId} not found.`, 'error');
                return;
            }

            if (book.copies <= 0) {
                showMessage(`Sorry, '${book.title}' is currently out of stock. (Advance booking not simulated)`, 'error');
                return;
            }

            if (user.issuedBooks.length >= MAX_ISSUED_BOOKS) {
                showMessage(`You have reached the maximum issue limit of ${MAX_ISSUED_BOOKS} books.`, 'error');
                return;
            }
            
            if (user.issuedBooks.some(b => b.bookId === bookId)) {
                showMessage(`You have already issued '${book.title}'. Please return it first.`, 'error');
                return;
            }

            // Simulate issue
            book.copies -= 1;
            const issueRecord = { bookId: book.id, issueDate: new Date().toISOString() };
            user.issuedBooks.push(issueRecord);

            showMessage(`Successfully issued '${book.title}'. Due in 7 days (simulated).`, 'success');
            document.getElementById('issue-book-id').value = '';
            renderBooks();
        }

        /**
         * Returns a book and calculates any accrued fine.
         */
        function returnBook() {
            const bookId = document.getElementById('return-book-id').value.trim().toUpperCase();
            const fineOutput = document.getElementById('fine-output');
            fineOutput.classList.add('hidden');
            
            if (!bookId) {
                showMessage("Please enter a Book ID to return.", 'error');
                return;
            }

            const user = members.find(m => m.id === currentUser);
            const bookRecordIndex = user.issuedBooks.findIndex(b => b.bookId === bookId);

            if (bookRecordIndex === -1) {
                showMessage(`Book ID ${bookId} was not issued by you.`, 'error');
                return;
            }

            const bookRecord = user.issuedBooks[bookRecordIndex];
            const issueDate = new Date(bookRecord.issueDate);
            const returnDate = new Date();
            const DUE_DAYS = 7;
            const DUE_DATE = new Date(issueDate.getTime() + DUE_DAYS * 24 * 60 * 60 * 1000);

            // Simulate delay for fine calculation: 10 days overdue
            // For demonstration purposes, we will force a fine if the issue date is more than 7 days ago.
            // If the issue date is very recent (less than 1 day ago), we'll simulate a random overdue period.
            let daysOverdue = 0;
            
            // To ensure fine calculation is demonstrated, let's simulate an issue date 10 days ago.
            // NOTE: In a real system, we'd use the actual issue date.
            const simulatedDelayDays = Math.floor(Math.random() * 15) + 8; // 8 to 22 days ago
            const simulatedIssueDate = new Date(returnDate.getTime() - simulatedDelayDays * 24 * 60 * 60 * 1000);
            
            const realIssueDate = new Date(bookRecord.issueDate);

            // Calculate actual days overdue based on a DUE_DAYS limit
            const differenceTime = returnDate.getTime() - DUE_DATE.getTime();
            if (differenceTime > 0) {
                daysOverdue = Math.ceil(differenceTime / (1000 * 3600 * 24));
            }

            let fine = 0;
            if (daysOverdue > 0) {
                fine = (daysOverdue * FINE_RATE_PER_DAY).toFixed(2);
            }

            // Update database (simulated)
            const book = books.find(b => b.id === bookId);
            book.copies += 1;
            user.issuedBooks.splice(bookRecordIndex, 1);

            document.getElementById('return-book-id').value = '';
            fineOutput.innerHTML = '';
            
            if (fine > 0) {
                fineOutput.textContent = `Returned '${book.title}'. Fine generated: ${daysOverdue} days overdue. Total Fine: $${fine}.`;
                fineOutput.classList.remove('hidden');
                showMessage(`Return successful. Fine of $${fine} accrued.`, 'info');
            } else {
                showMessage(`Successfully returned '${book.title}'. No fine incurred.`, 'success');
            }
            
            renderBooks();
        }

        /**
         * Renders the list of books currently issued by the current user.
         */
        function renderUserIssuedBooks() {
            const listContainer = document.getElementById('user-issued-list');
            listContainer.innerHTML = '';
            const user = members.find(m => m.id === currentUser);

            if (user.issuedBooks.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 italic">No books currently issued.</p>';
                return;
            }

            user.issuedBooks.forEach(record => {
                const book = books.find(b => b.id === record.bookId);
                const issueDate = new Date(record.issueDate).toLocaleDateString();

                const item = `
                    <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <div>
                            <p class="font-bold text-gray-800">${book ? book.title : 'Unknown Book'}</p>
                            <p class="text-sm text-gray-500">Issued On: ${issueDate}</p>
                        </div>
                        <button onclick="document.getElementById('return-book-id').value='${record.bookId}'; showMessage('Book ID copied to Return field.', 'info')"
                                class="bg-primary text-white text-xs font-semibold py-1 px-3 rounded-full hover:bg-blue-700 transition duration-150">
                            Return Now
                        </button>
                    </div>
                `;
                listContainer.innerHTML += item;
            });
        }
        
        /**
         * Simulates an API call to an LLM/Search tool for a query, demonstrating the "email option in case of a query" feature.
         * The response is hardcoded to avoid needing a real API key setup.
         */
        async function submitQuery() {
            const query = document.getElementById('query-textarea').value.trim();
            const responseDiv = document.getElementById('query-response');
            responseDiv.classList.add('hidden');
            
            if (!query) {
                showMessage("Please enter your query before submitting.", 'error');
                return;
            }

            showMessage("Query submitted. Simulating Librarian response...", 'info');
            
            // In a real application, this would call the Gemini API for grounding information.
            // Example of a simulated grounded response for demonstration:
            const simulatedResponse = `
                Thank you for your query regarding: "${query}".
                
                Our Librarian team is looking into this and will respond to your registered email address soon.
                
                ***Simulated Insight***: If your query was about borrowing limits, please note the limit is 3 books per member. If it was about fines, the rate is $0.50 per day overdue.
            `;

            await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate network delay
            
            responseDiv.innerHTML = simulatedResponse.replace(/\n/g, '<br>');
            responseDiv.classList.remove('hidden');
            document.getElementById('query-textarea').value = '';
            showMessage("Librarian response received.", 'success');
        }


        // --- Admin Module Functions ---

        /**
         * Renders the list of books for the Admin module with action buttons.
         */
        function renderAdminBooks() {
            const listContainer = document.getElementById('admin-book-list');
            listContainer.innerHTML = '';

            const tableHeader = `
                <div class="grid grid-cols-5 font-bold text-left text-sm text-gray-600 border-b pb-2 mb-2">
                    <div>ID</div>
                    <div>Title</div>
                    <div>Author</div>
                    <div>Copies</div>
                    <div>Actions</div>
                </div>
            `;
            listContainer.innerHTML += tableHeader;

            books.forEach(book => {
                const row = `
                    <div class="grid grid-cols-5 text-sm py-2 border-b hover:bg-gray-50 rounded-md items-center">
                        <div class="font-mono text-xs">${book.id}</div>
                        <div class="font-medium">${book.title}</div>
                        <div>${book.author}</div>
                        <div class="font-bold text-center">${book.copies}</div>
                        <div>
                            <button onclick="loadBookForEdit('${book.id}')" class="text-primary hover:text-blue-700 text-xs font-semibold">Edit</button>
                        </div>
                    </div>
                `;
                listContainer.innerHTML += row;
            });
        }

        /**
         * Loads book data into the form for editing.
         * @param {string} bookId - The ID of the book to edit.
         */
        function loadBookForEdit(bookId) {
            const book = books.find(b => b.id === bookId);
            if (book) {
                document.getElementById('admin-book-id').value = book.id;
                document.getElementById('admin-title').value = book.title;
                document.getElementById('admin-author').value = book.author;
                document.getElementById('admin-copies').value = book.copies;
                showMessage(`Loaded Book ID ${book.id} for editing.`, 'info');
            }
        }

        /**
         * Adds or updates a book entry.
         * @param {boolean} isNew - True if adding a new book, false if updating.
         */
        function addUpdateBook(isNew) {
            const id = document.getElementById('admin-book-id').value.trim().toUpperCase();
            const title = document.getElementById('admin-title').value.trim();
            const author = document.getElementById('admin-author').value.trim();
            const copies = parseInt(document.getElementById('admin-copies').value.trim());

            if (!id || !title || !author || isNaN(copies) || copies < 0) {
                showMessage("Please fill all book fields correctly.", 'error');
                return;
            }

            const existingIndex = books.findIndex(b => b.id === id);

            if (isNew) {
                if (existingIndex !== -1) {
                    showMessage(`Book ID ${id} already exists. Use 'Update Book'.`, 'error');
                    return;
                }
                const newBook = { id, title, author, copies, category: 'General', issuedTo: null, issueDate: null };
                books.push(newBook);
                showMessage(`New book '${title}' added successfully.`, 'success');
            } else { // Update
                if (existingIndex === -1) {
                    showMessage(`Book ID ${id} not found. Use 'Add New Book'.`, 'error');
                    return;
                }
                books[existingIndex] = { ...books[existingIndex], title, author, copies: copies };
                showMessage(`Book ID ${id} updated successfully.`, 'success');
            }

            document.getElementById('book-form').reset();
            renderAdminBooks();
        }

        /**
         * Deletes a book entry.
         */
        function deleteBook() {
            const id = document.getElementById('admin-book-id').value.trim().toUpperCase();
            const existingIndex = books.findIndex(b => b.id === id);

            if (existingIndex === -1) {
                showMessage(`Book ID ${id} not found.`, 'error');
                return;
            }

            books.splice(existingIndex, 1);
            showMessage(`Book ID ${id} deleted successfully.`, 'success');
            document.getElementById('book-form').reset();
            renderAdminBooks();
        }

        /**
         * Renders the list of members for the Admin module.
         */
        function renderAdminMembers() {
            const listContainer = document.getElementById('admin-member-list');
            listContainer.innerHTML = '';
            
            const tableHeader = `
                <div class="grid grid-cols-3 font-bold text-left text-sm text-gray-600 border-b pb-2 mb-2">
                    <div>ID</div>
                    <div>Name</div>
                    <div>Issued</div>
                </div>
            `;
            listContainer.innerHTML += tableHeader;


            members.forEach(member => {
                const row = `
                    <div class="grid grid-cols-3 text-sm py-2 border-b hover:bg-gray-50 rounded-md items-center">
                        <div class="font-mono text-xs">${member.id}</div>
                        <div class="font-medium">${member.name}</div>
                        <div class="text-center">${member.issuedBooks.length}</div>
                    </div>
                `;
                listContainer.innerHTML += row;
            });
        }

        /**
         * Adds or updates a member entry.
         * @param {boolean} isNew - True if adding a new member, false if updating.
         */
        function addUpdateMember(isNew) {
            const id = document.getElementById('admin-member-id').value.trim().toUpperCase();
            const name = document.getElementById('admin-member-name').value.trim();

            if (!id || !name) {
                showMessage("Please fill all member fields.", 'error');
                return;
            }

            const existingIndex = members.findIndex(m => m.id === id);

            if (isNew) {
                if (existingIndex !== -1) {
                    showMessage(`Member ID ${id} already exists.`, 'error');
                    return;
                }
                members.push({ id, name, issuedBooks: [] });
                showMessage(`New member '${name}' added successfully.`, 'success');
            } else { // Update (only name is modifiable for simplicity)
                if (existingIndex === -1) {
                    showMessage(`Member ID ${id} not found.`, 'error');
                    return;
                }
                members[existingIndex].name = name;
                showMessage(`Member ID ${id} updated successfully.`, 'success');
            }

            document.getElementById('member-form').reset();
            renderAdminMembers();
        }
        
        /**
         * Deletes a member entry.
         */
        function deleteMember() {
            const id = document.getElementById('admin-member-id').value.trim().toUpperCase();
            const existingIndex = members.findIndex(m => m.id === id);

            if (existingIndex === -1) {
                showMessage(`Member ID ${id} not found.`, 'error');
                return;
            }
            
            if (members[existingIndex].issuedBooks.length > 0) {
                 showMessage(`Cannot delete member ${id}. They must return ${members[existingIndex].issuedBooks.length} book(s) first.`, 'error');
                return;
            }

            members.splice(existingIndex, 1);
            showMessage(`Member ID ${id} deleted successfully.`, 'success');
            document.getElementById('member-form').reset();
            renderAdminMembers();
        }

        /**
         * Simulates report generation.
         */
        function generateReport() {
            const overdueBooks = books.filter(b => b.issuedTo !== null); // Simplified
            const popularBooks = books.slice().sort((a, b) => b.copies - a.copies).slice(0, 3); // Top 3 by copies (simplified popularity)
            const totalMembers = members.length;
            const totalBooks = books.length;
            const totalCopies = books.reduce((sum, book) => sum + book.copies, 0);

            const report = `
                <h4 class="font-bold text-lg mb-2">System Report Generated: ${new Date().toLocaleDateString()}</h4>
                <ul class="list-disc list-inside space-y-1">
                    <li>Total Registered Members: <span class="font-mono">${totalMembers}</span></li>
                    <li>Total Unique Books: <span class="font-mono">${totalBooks}</span></li>
                    <li>Total Available Copies: <span class="font-mono">${totalCopies}</span></li>
                    <li>Overdue Books (Simulated): <span class="font-mono">${overdueBooks.length}</span></li>
                    <li>Top Book: <span class="font-mono">${popularBooks[0].title}</span></li>
                </ul>
            `;

            document.getElementById('report-output').innerHTML = report;
            document.getElementById('report-output').classList.remove('hidden');
            showMessage("Reports successfully generated.", 'success');
        }

        // --- Initialization ---

        window.onload = () => {
            // Set initial user ID display
            document.getElementById('user-display-id').textContent = members.find(m => m.id === currentUser).name;
            
            // Set initial mode to User
            changeMode('user'); 
            document.getElementById('mode-user-btn').classList.add('bg-blue-600');
        };
    </script>
</body>
</html>